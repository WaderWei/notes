# 分库分表

### 垂直切分与水平切分

![1571555994274](.\分库分表.assets\1571555994274.png)

![1571556056439](.\分库分表.assets\1571556056439.png)

![1571556101288](.\分库分表.assets\1571556101288.png)![1571556145591](.\分库分表.assets\1571556145591.png)![1571556229322](.\分库分表.assets\1571556229322.png)![1571556318150](.\分库分表.assets\1571556318150.png)![1571556351658](.\分库分表.assets\1571556351658.png)![1571556423504](.\分库分表.assets\1571556423504.png)

![1571556474698](.\分库分表.assets\1571556474698.png)

### 安装mycat

![1571556636844](.\分库分表.assets\1571556636844.png)

![1571556681939](.\分库分表.assets\1571556681939.png)![1571556808841](.\分库分表.assets\1571556808841.png)![1571556828559](.\分库分表.assets\1571556828559.png)![1571556872067](.\分库分表.assets\1571556872067.png)![1571556981295](.\分库分表.assets\1571556981295.png)

-d：docker容器在后台运行

-it：docker容器运行不退出

-v：数据卷映射

--net=host：mycat挂载的网络一定要是宿主主机的ip

![1571557193025](.\分库分表.assets\1571557193025.png)

mycat要使用两个端口

8066：做数据处理，执行的sql语句交给8066端口处理

9066：获取mycat运行信息

**端口开放以后，要重启其它节点docker服务。**

![1571557355866](.\分库分表.assets\1571557355866.png)

查看mycat信息，并将mycat压缩包上传至虚拟机的映射路径，然后解压

![1571557477616](.\分库分表.assets\1571557477616.png)

查看容器中是否有mycat



### 配置PXC集群负载均衡

![1571557566861](.\分库分表.assets\1571557566861.png)

mycat只做sql路由的转发，一般只需要一个mycat就行，但防止mycat挂掉了，而导致程序奔溃，一般会布置一个冗余的mycat2，它一般处于待机状态。

![1571557684024](.\分库分表.assets\1571557684024.png)

 ![1571557773482](.\分库分表.assets\1571557773482.png)![1571557817056](.\分库分表.assets\1571557817056.png)

![1571557884521](.\分库分表.assets\1571557884521.png)![1571558062654](.\分库分表.assets\1571558062654.png)![1571558311130](.\分库分表.assets\1571558311130.png)

pxc的每个节点数据库都是可读可写，强一致性

![1571558377005](.\分库分表.assets\1571558377005.png)

这里要与server.xml中的schemas配置的属性值相同



![1571558530679](.\分库分表.assets\1571558530679.png)

balance：0：不使用读写分离，所有的读写请求都发给写节点     

witeType： 1：所有的请求随机发送到可用的写节点

![1571558796521](.\分库分表.assets\1571558796521.png)

复制一个dataHost配置第二个分片的pxc集群，即mycat管理了两个pxc的集群分片。

pxc分片是为了做数据的切分。



### 配置Replication集群的读写分离

![1571578507237](.\分库分表.assets\1571578507237.png)

只有一个主节点的情况下，当主节点挂掉，就不能够往数据库中写数据了，因此要有两个主节点能够相互同步，当一个主节点挂掉后，另一个主节点依然能用，但此主节点的从节点也没用了，即mycat不会向挂掉的主节点的从节点发出读的请求。

![1571579180672](.\分库分表.assets\1571579180672.png)

balance=3：读写分离，写节点只能增删改，读节点只能读

配置两个replication集群

![1571579433243](.\分库分表.assets\1571579433243.png)

![1571579475464](.\分库分表.assets\1571579475464.png)

 下载mycat.pdf 到80页左右查看相关配置



## 配置虚拟库和虚拟表

![1571580067420](.\分库分表.assets\1571580067420.png)

![1571580347782](.\分库分表.assets\1571580347782.png)

pxc1与pxc2对应的逻辑库都是t1，起到的是水平切分的作用

pxc1，pxc2  与 rep1，rep2对应的逻辑库分别是t1和t2，起到的是垂直切分的作用

![1571581284108](.\分库分表.assets\1571581284108.png)

schema节点：

t2：虚拟逻辑库的名字

checkSQLschema：false：不改变from后面的字符串

sqlMaxLimit=100：表示最多返回100条数据



table节点：

name：为虚拟表的名字

type：global，表示这张表不用水平拆分，全局保存在tdn3，tdn4（replication集群）数据库节点中

rule：mod-long，表示根据主键进行除count取模

![1571581937707](.\分库分表.assets\1571581937707.png)

t1：用于保存pcx集群重要的数据



![1571582008124](.\分库分表.assets\1571582008124.png)

将t1，t2加入到虚拟账户之中



![1571582151884](.\分库分表.assets\1571582151884.png)



### 启动MyCat

![1571582455861](.\分库分表.assets\1571582455861.png)

这两个日志文件记录了mycat无法启动的详细报错

![1571582580616](.\分库分表.assets\1571582580616.png)

创建los文件夹



![1571582633351](.\分库分表.assets\1571582633351.png)



**navicat连接mycat只能通过sql语句建表。**  navicat连接的是mycat虚拟账户

可以用图形界面修改数据



### MyCat实现水平切分和垂直切分

![1571583377642](.\分库分表.assets\1571583377642.png)

![1571583546722](.\分库分表.assets\1571583546722.png)

![1571583567151](.\分库分表.assets\1571583567151.png)

### 什么是全局表

![1571584791402](.\分库分表.assets\1571584791402.png)

![1571584828195](.\分库分表.assets\1571584828195.png)

![1571584902229](.\分库分表.assets\1571584902229.png)

### 水平切分规则：主键求模

![1571585178498](.\分库分表.assets\1571585178498.png)

![1571585238252](.\分库分表.assets\1571585238252.png)

增加新的分片，会导致硬件的成本提高，另外分片1与23的数据也要有一部分转移到分片4

![1571585359012](.\分库分表.assets\1571585359012.png)

自定义规则：

1. 添加一个function

   ![1571585522477](.\分库分表.assets\1571585522477.png)

2. 添加一个对应的tablerule

   ![1571585561952](.\分库分表.assets\1571585561952.png)

3. 在schema.xml中修改虚拟表对应的切分规则

   ![1571585618549](.\分库分表.assets\1571585618549.png)



![1571585893891](.\分库分表.assets\1571585893891.png)



### 水平切分规则：枚举切分

![1571586037175](.\分库分表.assets\1571586037175.png)

![1571586114920](.\分库分表.assets\1571586114920.png)

**在mycat/conf目录下创建.txt枚举数据分片规则文件**

![1571586236638](.\分库分表.assets\1571586236638.png)

![1571586308770](.\分库分表.assets\1571586308770.png)

![1571586351945](.\分库分表.assets\1571586351945.png)![1571586418758](.\分库分表.assets\1571586418758.png)

![1571586473111](.\分库分表.assets\1571586473111.png)



### 创建热加载，不用每次修改配置文件都重启mycat

1. navicat新建连接

   ![1571586558083](.\分库分表.assets\1571586558083.png)



注意：MyCat管理这个连接不要点击虚拟库，会报错，这个连接是给我们管理mycat的，只能用命令。

![1571586675895](.\分库分表.assets\1571586675895.png)

这样就不用重新启动mycat了。



![1571586750966](.\分库分表.assets\1571586750966.png)

测试自定义枚举规则切分数据，创建表



### 避免跨分片表连接：父子表

全局表和全局表，全局表和分片表做表连接都很简单，因为全局表在每个分片中都存在，因此全局表可以和任何表做表连接。

![1571587243034](.\分库分表.assets\1571587243034.png)

![1571587338354](.\分库分表.assets\1571587338354.png)

![1571587396629](.\分库分表.assets\1571587396629.png)

子表的数据要跟随父表插入到同一个分片中，这样就避免了数据的连接不在同一个分片中





![1571587660999](.\分库分表.assets\1571587660999.png)

primaryKey：配置则表示有缓存

joinKey 与 parentKey 表示关联属性，即父子表的连接id

![1571587913170](.\分库分表.assets\1571587913170.png)

childTable：下面仍然可以关联子表，即跟随customer数据分到同一个分片

记得热加载一下mycat。



![1571588010580](.\分库分表.assets\1571588010580.png)

创建测试的虚拟表 ，**声明虚拟表的时候，字符集一定要改为utf8，mycat默认是拉丁文无法保存中文**



