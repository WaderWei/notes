# 数据库性能调优

### 什么是压力测试

![1571235937507](.\数据库性能调优.assets\1571235937507.png)

### 压力测试指标

![1571235972152](.\数据库性能调优.assets\1571235972152.png)

### 压力测试工具

![1571236041046](.\数据库性能调优.assets\1571236041046.png)

![1571236098476](.\数据库性能调优.assets\1571236098476.png)

### 设置yum源

![1571236148036](.\数据库性能调优.assets\1571236148036.png)

### Sysbench安装(不能和mysql8.0安装在一起)

![1571236216723](.\数据库性能调优.assets\1571236216723.png)





![1571236287944](.\数据库性能调优.assets\1571236287944.png)

![1571236324678](.\数据库性能调优.assets\1571236324678.png)

![1571236335987](.\数据库性能调优.assets\1571236335987.png)

simple：只测试查询

nontrx：无事务的增删改查测试(针对的是MyISAM引擎)

complex：测试有事务的增删改查

![1571236573514](.\数据库性能调优.assets\1571236573514.png)

1. 准备数据

   ![1571236702029](.\数据库性能调优.assets\1571236702029.png)

   **注意要新建一个数据库，名字必须是sbtest**

2. 执行测试

   ![1571236780041](.\数据库性能调优.assets\1571236780041.png)

3. 查看结果

   ![1571236979127](.\数据库性能调优.assets\1571236979127.png)

   TPS:每秒执行238.16个事务

   QPS:每秒执行4815.90个查询

   错误：每秒3.26个错误（当数据库满负荷执行时，会存在一些请求超时）



### SQL语句优化

![1571317450678](.\数据库性能调优.assets\1571317450678.png)

***** 会筛选所有的字段，增大了数据量，即I/O流传输的数据变多。

![1571317674120](.\数据库性能调优.assets\1571317674120.png)

第一条：模糊查询的%如果写在开头，数据库是没法用索引查询，而是全表扫描

第二条：能够使用索引



![1571317760614](.\数据库性能调优.assets\1571317760614.png)

![1571317823354](.\数据库性能调优.assets\1571317823354.png)

第一条：索引是二叉树，空值没法排序，因此给comm设置索引也没有，会全表扫描

2,3：comm没有值时设置为-1，这样能够使用索引

![1571318064893](.\数据库性能调优.assets\1571318064893.png)

1.  索引是二叉树结构，不等于不会用索引，而是全表扫描。
2. 写成< and > 等形式，会走索引



![1571318193439](.\数据库性能调优.assets\1571318193439.png)

1. deptno=20会走索引，而加了or deptno=30会进行全表扫描
2. 利用union all 进行 优化

![1571318286114](.\数据库性能调优.assets\1571318286114.png)

1. in 与 not in 也是 or的关系，全表扫描



![1571318344324](.\数据库性能调优.assets\1571318344324.png)

![1571318415067](.\数据库性能调优.assets\1571318415067.png)

### Mysql参数优化

![1571318671585](.\数据库性能调优.assets\1571318671585.png)

1. max_connections：数据库支持最大的并发连接数
2. max_used_connections：使用过最多的连接数

修改mysql最大并发连接数

/etc----->my.cnf

![1571318836099](.\数据库性能调优.assets\1571318836099.png)

重启mysql

![1571318885988](.\数据库性能调优.assets\1571318885988.png)

![1571318954663](.\数据库性能调优.assets\1571318954663.png)

![1571319037144](.\数据库性能调优.assets\1571319037144.png)

当请求并发量超过了mysql最大支持的并发数，会将请求存到back_log中，默认50，一般设置为max_connections的20%-30%左右

![1571319178513](.\数据库性能调优.assets\1571319178513.png)

 ![1571319261791](.\数据库性能调优.assets\1571319261791.png)

![1571319307087](.\数据库性能调优.assets\1571319307087.png)

因为这里是在虚拟机上

虚拟机配置：内存1GB，CPU核心：1



![1571319835871](.\数据库性能调优.assets\1571319835871.png)

![1571319991906](.\数据库性能调优.assets\1571319991906.png)

![1571320051243](.\数据库性能调优.assets\1571320051243.png)



### MySql慢查询日志

![1571320358975](.\数据库性能调优.assets\1571320358975.png)

![1571320401344](.\数据库性能调优.assets\1571320401344.png)

设置慢查询开启状态，查询时间1S就记录在慢查询日志中

![1571320458123](.\数据库性能调优.assets\1571320458123.png)



![1571320649104](.\数据库性能调优.assets\1571320649104.png)

利用explain来模拟sql执行语句，得到优化器的分析结果

![1571320720905](.\数据库性能调优.assets\1571320720905.png)

all：全表扫描

![1571320755527](.\数据库性能调优.assets\1571320755527.png)

根据索引扫描



